{% extends "base.html" %} {% block title %}Bài Kiểm Tra{% endblock %} {% block
content %}
<h1>
  {% if set_number %} Bài Kiểm Tra - Bộ đề {{ set_number }} - {% if test_type ==
  'meaning' %}Nghĩa{% else %}Pinyin{% endif %} {% else %} Kiểm Tra Ngẫu Nhiên -
  {% if test_type == 'meaning' %}Nghĩa{% else %}Pinyin{% endif %} {% endif %}
</h1>
<div class="question-list">
  <h2>Danh sách câu hỏi:</h2>
  <div class="questions">
    {% for question in test_data.questions %}
    <a
      href="{% if set_number %}{{ url_for('test_set', set_number=set_number, q=question.index, test_type=test_type) }}{% else %}{{ url_for('test_random', q=question.index, test_type=test_type) }}{% endif %}"
      class="question-item {% if question.selected_choice %}answered{% endif %} {% if question.is_marked %}marked{% endif %}"
    >
      Câu {{ question.index }}
    </a>
    {% endfor %}
  </div>
</div>
<div class="current-question">
  <h2>
    Câu {{ current_question.index }}: Bộ thủ {{ current_question.radical }}
  </h2>
  {% if test_type == 'meaning' %}
  <p>Chọn nghĩa đúng của bộ thủ này:</p>
  {% else %}
  <p>Chọn pinyin đúng của bộ thủ này:</p>
  {% endif %}
  <form id="question-form" method="post">
    {% for choice in current_question.choices %}
    <div class="choice">
      <input type="radio" name="selected_choice" value="{{ choice }}"
      id="choice{{ loop.index }}" {% if current_question.selected_choice ==
      choice %}checked{% endif %}>
      <label for="choice{{ loop.index }}">{{ choice }}</label>
    </div>
    {% endfor %}
    <input
      type="hidden"
      name="question_index"
      value="{{ current_question.index }}"
    />
    <input type="hidden" name="action" value="save_answer" />
  </form>
  <button id="clear-answer-button" class="button">Xóa câu trả lời</button>
  <button
    id="mark-question-button"
    class="button {% if current_question.is_marked %}marked{% endif %}"
  >
    {% if current_question.is_marked %}Bỏ đánh dấu{% else %}Đánh dấu câu hỏi{%
    endif %}
  </button>
</div>
<form method="post" class="submit-form">
  <input type="hidden" name="action" value="submit_test" />
  <button type="submit" class="button submit-button">Nộp bài</button>
</form>
<script>
  document
    .querySelectorAll('input[name="selected_choice"]')
    .forEach(function (input) {
      input.addEventListener("change", function () {
        let questionIndex = document.querySelector(
          'input[name="question_index"]'
        ).value;

        // Cập nhật giao diện ngay lập tức
        document
          .querySelector(`.question-item:nth-child(${questionIndex})`)
          .classList.add("answered");

        let formData = new FormData();
        formData.append("action", "save_answer");
        formData.append("question_index", questionIndex);
        formData.append("selected_choice", this.value);

        fetch(window.location.href, { method: "POST", body: formData })
          .then((response) => response.json())
          .catch((error) => console.error("Lỗi:", error));
      });
    });

  document
    .getElementById("mark-question-button")
    .addEventListener("click", function () {
      let questionIndex = document.querySelector(
        'input[name="question_index"]'
      ).value;
      let questionItem = document.querySelector(
        `.question-item:nth-child(${questionIndex})`
      );

      // Cập nhật giao diện ngay lập tức
      if (this.classList.contains("marked")) {
        this.classList.remove("marked");
        this.textContent = "Đánh dấu câu hỏi";
        questionItem.classList.remove("marked");
      } else {
        this.classList.add("marked");
        this.textContent = "Bỏ đánh dấu";
        questionItem.classList.add("marked");
      }

      let formData = new FormData();
      formData.append("action", "mark_question");
      formData.append("question_index", questionIndex);

      fetch(window.location.href, { method: "POST", body: formData })
        .then((response) => response.json())
        .catch((error) => console.error("Lỗi:", error));
    });

  document
    .getElementById("clear-answer-button")
    .addEventListener("click", function () {
      let questionIndex = document.querySelector(
        'input[name="question_index"]'
      ).value;
      let questionItem = document.querySelector(
        `.question-item:nth-child(${questionIndex})`
      );

      // Bỏ chọn tất cả các radio button
      document
        .querySelectorAll('input[name="selected_choice"]')
        .forEach((input) => {
          input.checked = false;
        });

      // Xóa lớp "answered" khỏi câu hỏi trong danh sách
      questionItem.classList.remove("answered");

      // Gửi yêu cầu xóa câu trả lời đến máy chủ
      let formData = new FormData();
      formData.append("action", "clear_answer");
      formData.append("question_index", questionIndex);

      fetch(window.location.href, { method: "POST", body: formData })
        .then((response) => response.json())
        .catch((error) => console.error("Lỗi:", error));
    });
</script>
{% endblock %}
